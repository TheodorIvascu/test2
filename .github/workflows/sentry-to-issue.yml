name: Create GitHub Issue from Sentry

on:
  workflow_dispatch:
    inputs:
      issue_id:
        description: 'Sentry Issue ID (e.g. 45142381)'
        required: true
        type: string

jobs:
  create_github_issue:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4  # ✅ needed for gh CLI to work properly

      - name: Install jq and gh CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gh

      - name: Create GitHub issue from Sentry
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SENTRY_TOKEN: ${{ secrets.SENTRY_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
        run: |
          ISSUE_ID="${{ github.event.inputs.issue_id }}"

          EVENT=$(curl -s -H "Authorization: Bearer $SENTRY_TOKEN" \
            "https://sentry.io/api/0/issues/$ISSUE_ID/events/latest/")

          if [ "$EVENT" == "null" ] || [ -z "$EVENT" ]; then
            echo "❌ No event data found for issue ID $ISSUE_ID."
            exit 1
          fi

          TITLE=$(echo "$EVENT" | jq -r '.title')
          CULPRIT=$(echo "$EVENT" | jq -r '.culprit')
          TIMESTAMP=$(echo "$EVENT" | jq -r '.dateCreated')
          URL=$(echo "$EVENT" | jq -r '.request.url // "N/A"')
          USER=$(echo "$EVENT" | jq -r '.user.email // "unknown"')
          PLATFORM=$(echo "$EVENT" | jq -r '.platform')

          HAS_FRAMES=$(echo "$EVENT" | jq '.exception.values[0].stacktrace.frames != null')
          if [ "$HAS_FRAMES" = "true" ]; then
            TRACE=$(echo "$EVENT" | jq -r '
              .exception.values[0].stacktrace.frames 
              | map("\(.function // "unknown") in \(.filename // "unknown"):\(.lineno // 0)") 
              | .[-3:] 
              | join("\n")')
          else
            TRACE="No stack trace available."
          fi

          echo "### 🐞 Sentry Bug Report" > body.txt
          echo "" >> body.txt
          echo "**Sentry Issue:** https://sentry.io/organizations/$SENTRY_ORG/issues/$ISSUE_ID/" >> body.txt
          echo "" >> body.txt
          echo "- **Title**: $TITLE" >> body.txt
          echo "- **Timestamp**: $TIMESTAMP" >> body.txt
          echo "- **Culprit**: $CULPRIT" >> body.txt
          echo "- **Platform**: $PLATFORM" >> body.txt
          echo "- **User**: $USER" >> body.txt
          echo "- **URL**: $URL" >> body.txt
          echo "" >> body.txt
          echo "**Stack trace (last 3 frames):**" >> body.txt
          echo '```' >> body.txt
          echo "$TRACE" >> body.txt
          echo '```' >> body.txt

          gh issue create --title "$TITLE" --body-file body.txt
